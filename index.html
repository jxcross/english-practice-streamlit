<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff4081">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>English Practice Player</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="noise"></div>
    
    <div class="container">
        <!-- Upload Section (Initially visible) -->
        <div class="upload-card" id="uploadCard">
            <div class="upload-header">
                <h1 class="upload-title">English Practice Player</h1>
                <p class="upload-subtitle">영어 학습 플레이어</p>
                <button class="back-btn" id="goToPlayerBtn" onclick="showPlayerScreen()" style="display: none;">▶️ 재생</button>
            </div>

            <div class="upload-methods">
                <!-- CSV Upload -->
                <div class="upload-method">
                    <label for="csvUpload" class="upload-btn primary">
                        <span class="upload-icon">📂</span>
                        <span class="upload-text">CSV 파일 업로드</span>
                        <input type="file" id="csvUpload" accept=".csv" hidden>
                    </label>
                    <p class="upload-hint">english, korean 컬럼이 포함된 CSV 파일</p>
                </div>

                <!-- Text Paste -->
                <div class="upload-method">
                    <textarea 
                        id="pasteArea" 
                        placeholder="CSV 형식: english,korean&#10;&quot;Hello&quot;,&quot;안녕하세요&quot;&#10;&quot;How are you?&quot;,&quot;어떻게 지내세요?&quot;&#10;&#10;또는 줄 단위:&#10;Hello&#10;안녕하세요&#10;How are you?&#10;어떻게 지내세요?"
                        rows="8"></textarea>

                    <div class="paste-buttons">
                        <button onclick="pasteFromClipboard()" class="upload-btn secondary">
                            <span class="upload-icon">📋</span>
                            <span class="upload-text">클립보드에서 가져오기</span>
                        </button>
                        <button onclick="parseText()" class="upload-btn primary">
                            <span class="upload-icon">➕</span>
                            <span class="upload-text">플레이리스트 생성</span>
                        </button>
                    </div>
                </div>

                <!-- Sample Data -->
                <div class="upload-method">
                    <button onclick="loadSampleData()" class="upload-btn secondary">
                        <span class="upload-icon">🎯</span>
                        <span class="upload-text">샘플 데이터로 시작하기</span>
                    </button>
                </div>
            </div>

            <!-- API Key Section -->
            <div class="api-key-section">
                <h3 class="api-key-section-title">🔑 Google Cloud TTS API Key</h3>
                <p class="api-key-section-description">Google Cloud TTS를 사용하려면 API 키가 필요합니다. API 키는 메모리에만 저장되며, 페이지를 닫으면 자동으로 삭제됩니다.</p>
                <div class="api-key-input-group">
                    <input 
                        type="password" 
                        id="apiKeyInputUpload" 
                        class="api-key-input" 
                        placeholder="AIzaSy..."
                        autocomplete="off"
                    >
                    <button class="api-key-toggle-visibility" type="button" onclick="toggleApiKeyVisibilityUpload()" id="toggleVisibilityBtnUpload">👁️</button>
                    <button class="api-key-save-btn" onclick="saveApiKeyFromUpload()">저장</button>
                    <button class="api-key-delete-btn" onclick="deleteApiKeyFromUpload()" id="apiKeyDeleteBtnUpload" style="display: none;">삭제</button>
                </div>
                <div class="api-key-status-upload" id="apiKeyStatusUpload">
                    <span class="api-key-status-label">상태:</span>
                    <span class="api-key-status-value" id="apiKeyStatusValueUpload">Not Set</span>
                </div>
            </div>

            <!-- Saved Playlists -->
            <div class="saved-playlists" id="savedPlaylists" style="display: none;">
                <h3 class="saved-title">저장된 플레이리스트</h3>
                <div id="playlistList"></div>
            </div>
        </div>

        <!-- Player Card (Initially hidden) -->
        <div class="player-card" id="playerCard" style="display: none;">
            <div class="player-header">
                <button class="back-btn" onclick="showUploadScreen()">← 목록</button>
                <div class="player-title">ENGLISH PRACTICE</div>
                <div class="track-info" id="trackInfo">1 of 16</div>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="display-area">
                <div class="time-display" id="timeDisplay">00.00s / 00.00s</div>
                <div class="text-english" id="textEnglish">Select a playlist to start</div>
                <div class="text-korean" id="textKorean">플레이리스트를 선택하세요</div>

                <!-- Loading Spinner -->
                <div class="loading-spinner" id="loadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                    <p>Generating high-quality audio...</p>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn" onclick="firstTrack()" aria-label="First track" title="첫 문장">⏮️</button>
                <button class="control-btn" onclick="prevTrack()" aria-label="Previous track" title="이전 문장">⏪</button>
                <button class="control-btn primary" id="playBtn" onclick="togglePlay()" aria-label="Play">▶️</button>
                <button class="control-btn" onclick="nextTrack()" aria-label="Next track" title="다음 문장">⏩</button>
                <button class="control-btn" onclick="lastTrack()" aria-label="Last track" title="마지막 문장">⏭️</button>
                <div class="repeat-control-inline">
                    <button class="repeat-btn" onclick="setRepeat('one')" data-mode="one" title="한 곡 반복">🔂</button>
                    <button class="repeat-btn" onclick="setRepeat('all')" data-mode="all" title="전체 반복">🔁</button>
                </div>
            </div>

            <div class="secondary-controls">
                <div class="speed-control">
                    <span class="speed-label">SPEED</span>
                    <button class="speed-btn" onclick="setSpeed(0.5)">0.5x</button>
                    <button class="speed-btn" onclick="setSpeed(0.75)">0.75x</button>
                    <button class="speed-btn active" onclick="setSpeed(1)">1x</button>
                    <button class="speed-btn" onclick="setSpeed(1.25)">1.25x</button>
                    <button class="speed-btn" onclick="setSpeed(1.5)">1.5x</button>
                    <button class="speed-btn" onclick="setSpeed(2)">2x</button>
                </div>
            </div>

            <!-- TTS Settings -->
            <div class="tts-settings">
                <div class="tts-mode-selection">
                    <label for="ttsModeSelect" class="tts-label">🎙️ TTS ENGINE</label>
                    <select id="ttsModeSelect" onchange="changeTTSMode()" class="tts-select">
                        <option value="auto">Auto (Recommended)</option>
                        <option value="google">Google Cloud (High Quality)</option>
                        <option value="webspeech">Browser TTS (Offline)</option>
                    </select>
                </div>

            <div class="voice-selection">
                <label for="voiceSelect" class="voice-label">🎤 VOICE</label>
                <select id="voiceSelect" onchange="changeVoice()" class="voice-select" disabled>
                    <option value="">Auto (Best English)</option>
                </select>
            </div>
            </div>


            <div class="playlist-section">
                <div class="playlist-header">
                    <div class="playlist-title">PLAYLIST</div>
                    <div class="playlist-actions">
                        <button class="playlist-action-btn" onclick="savePlaylist()" title="플레이리스트 저장">💾</button>
                        <button class="playlist-action-btn" onclick="exportPlaylist()" title="CSV로 내보내기">📥</button>
                        <span class="playlist-count" id="playlistCount">0 tracks</span>
                    </div>
                </div>
                <div class="playlist-items" id="playlistItems">
                    <!-- Playlist items will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Input Modal -->
    <div class="modal-overlay" id="apiKeyModal" style="display: none;" onclick="if(event.target === this) closeApiKeyModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title">Google Cloud TTS API Key</h2>
                <button class="modal-close" onclick="closeApiKeyModal()">×</button>
            </div>
            <div class="modal-body">
                <p class="modal-description">
                    Google Cloud TTS를 사용하려면 API 키가 필요합니다.<br>
                    API 키는 메모리에만 저장되며, 페이지를 닫으면 자동으로 삭제됩니다.
                </p>
                <div class="modal-input-group">
                    <label for="apiKeyInput" class="modal-label">API Key</label>
                    <input 
                        type="password" 
                        id="apiKeyInput" 
                        class="modal-input" 
                        placeholder="AIzaSy..."
                        autocomplete="off"
                    >
                    <button class="modal-toggle-visibility" type="button" onclick="toggleApiKeyVisibility()" id="toggleVisibilityBtn">👁️</button>
                </div>
                <div class="modal-error" id="apiKeyError" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" onclick="closeApiKeyModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveApiKeyFromModal()">Save</button>
            </div>
        </div>
    </div>

    <!-- Debug Panel -->
    <button id="debugToggleBtn" onclick="toggleDebugPanel()" style="
        position: fixed;
        bottom: 10px;
        right: 10px;
        padding: 8px 12px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        border: 1px solid #333;
        border-radius: 6px;
        cursor: pointer;
        z-index: 10001;
        font-size: 12px;
        font-weight: 600;
    ">🐛 Debug</button>
    
    <div id="debugPanel" style="
        position: fixed;
        bottom: 50px;
        right: 10px;
        width: 300px;
        max-height: 300px;
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.9);
        color: #00ff00;
        padding: 12px;
        border-radius: 8px;
        font-family: 'JetBrains Mono', monospace;
        font-size: 11px;
        z-index: 10000;
        display: none;
        border: 1px solid #333;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    "></div>

    <script src="app.js"></script>
    <script>
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed'));
        }
    </script>
</body>
</html>
